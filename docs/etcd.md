<div align="center">
<img src="images/netsatbench_logo.png" alt="NetSatBench Logo" width="200"/>

# NetSatBench ETCD Keyspace 

</div>

The ETCD keyspace used by NetSatBench follows a hierarchical, declarative schema, where each prefix corresponds to a logical subsystem of the emulator. 
The content of the etcd keyspace can be inspected using standard etcd tools, e.g., from the control host via the command:

```bash
etcdctl get --prefix /config
```

The main prefixes are structured as follows:
```
/config
│
├── workers
│   ├── <worker-name>
│   ├── ...
│   └── <worker-name>
│
├── L3-config-common
│
├── epoch-config
│
├── etchosts
│   ├── <node-name>
│   ├── ...
│   └── <node-name>
│
├── satellites
│   ├── <node-name>
│   ├── ...
│   └── <node-name>
│
├── grounds
│   ├── <node-name>
│   ├── ...
│   └── <node-name>
│
├── users
│   ├── <node-name>
│   ├── ...
│   └── <node-name>
│
├── links
│   ├── <node-name>/<interface-name>
│   ├── ...
│   └── <node-name>/<interface-name>
│
└── run
    ├── <node-name>
    ├── ...
    └── <node-name>
```
---

## /config/workers/

This prefix contains the list of worker hosts participating in the emulation, indexed by worker name.  
Each worker is associated with a JSON configuration derived from the `worker-config.json` file (see the [configuration manual](configuration.md)).  
These entries are automatically created and managed by the `control/system-init-docker.py` script.

### Example

/config/workers/host-1  
Stores the configuration data of the worker host named `host-1`.

```json
{
  "ip": "10.0.1.215",
  "ssh_user": "ubuntu",
  "ssh_key": "/home/ubuntu/.ssh/id_rsa",
  "sat-vnet": "sat-vnet",
  "sat-vnet-cidr": "172.100.0.0/16",
  "sat-vnet-super-cidr": "172.0.0.0/8",
  "cpu": "4",
  "mem": "6GiB"
}
```

---
## /config/L3-config-common|epoch-config|satellite|ground|user
These prefixes contain the configuration data of the emulated node indexed by name as defined in the sat-config.json file (see the [configuration manual](configuration.md)). They are automatically created and managed by the control/constellation-init.py script.

### Example
/config/satellites/sat1
```json
{
 "worker": "host-1", 
 "image": "msvcbench/sat-container:latest", 
 "subnet_cidr": "192.168.0.0/29",
 "cpu-request": "100m",
 "mem-request": "200Mi",
 "cpu-limit": "200m",
 "mem-limit": "400Mi", 
 "eth0_ip": "172.100.0.5"
}
```
In addition to the parameters specified in sat-config.json, the `eth0_ip` field defines the IP address assigned to the eth0 interface of the node container.
This address is used to establish the overlay VXLAN links between nodes and is automatically managed by the sat-agent running inside each container during initialization.
The subnet_cidr field can be automatically assigned if the `auto-assign-super-cidr` field is set.

/config/L3-config-common
```json
{
 "enable-netem"  : true,
 "enable-routing" : true,
 "routing-module": "extra.isis",
  "routing-metadata": {
      "isis-area-id": "0001"
    },
 "auto-assign-ips": true,
 "auto-assign-super-cidr": "192.168.0.0/16"
}
```
/config/epoch-config
```json
{
 "epoch-dir": "examples/10nodes/constellation-epochs", 
 "file-pattern": "NetSatBench-epoch*.json"
}
```

## /config/etchosts/
This prefix holds the overlay IP address assigned to the loopback interface (if assigned) for each emulated node, indexed by node name.
These entries are automatically created and managed by the sat-agent, which configures the /etc/hosts file inside each container, allowing workloads to refer to nodes by name rather than by overlay IP address.
### Example

/config/etchosts/sat1
```json
 192.168.0.6
```

## /config/links/
This prefix contains the state of all emulated links in the current epoch, indexed by source node and interface name.
Each entry stores a JSON object describing the current link parameters, such as delay, packet loss, bandwidth, and VXLAN identifier.
These entries are automatically created and managed by the control/constellation-run.py script while processing epoch files.

### Example

/config/links/sat1/vl_sat2_1
```json
{
 "endpoint1": "sat1", 
 "endpoint2": "sat2", 
 "rate": "10mbit",
 "loss": 0, 
 "delay": "1ms", 
 "vni": 13475210
}
```
The key `sat1/vl_sat2_1` indicates a link originating from node `sat1` on interface `vl_sat2_1`. Both the interface name and the corresponding VNI are automatically generated by the constellation-run.py script when the link is instantiated.

## /config/run/
This prefix stores runtime information for each emulated node, indexed by node name.
Each entry contains a JSON array specifying the sequence of commands to be executed during the current epoch.
These entries are automatically created and managed by the constellation-run.py script.
### Example
/config/run/grd1
```json
["sleep 10", "screen -dmS iperf_test iperf3 -s"]
```
The key `grd1` indicates that these commands are to be executed inside the container of node `grd1` during the current epoch.